PACKAGED_TEMPLATE = aws-sam-packaged.yaml
S3_BUCKET := $(AWS_S3_BUCKET)
STACK_NAME := $(STACK_NAME)
TEMPLATE = aws-sam-template.yaml

.PHONY: test
test:
	go test ./...

.PHONY: clean
clean:
	rm -f $(PACKAGED_TEMPLATE)
	./clean-lambdas.sh

.PHONY: awslambda
lambda:
	./build-lambdas.sh

.PHONY: build
build: clean awslambda

.PHONY: api
api: build
	sam local start-api --profile $(AWS_PROFILE) --region $(AWS_REGION)

.PHONY: package
package: build
	sam package --template-file $(TEMPLATE) --s3-bucket $(S3_BUCKET) --output-template-file $(PACKAGED_TEMPLATE)

.PHONY: deploy
deploy: package
	sam deploy --stack-name $(STACK_NAME) --template-file $(PACKAGED_TEMPLATE) --capabilities CAPABILITY_IAM